<dom-module id="saint-laurent">
  <style type="text/css">
    :host {
      display: block;
      position: relative;
      margin: 0px;
    }
  </style>
  <template>
    <template is="dom-repeat" items="{{stations}}">
      <saint-laurent-station
          stop-id="[[item.stop]]"
          route-id="[[item.route]]"
          direction-id="[[item.direction]]"
          label="[[item.label]]"
          color="[[item.color]]"></saint-laurent-station>
      <!-- <saint-laurent-station-new
          stop-id$="[[item.stop]]"
          route-id$="[[item.route]]"
          direction-id$="[[item.direction]]"
          label$="[[item.label]]"
          color$="[[item.color]]"></saint-laurent-station-new> -->
    </template>
  </template>
</dom-module>

<script>

  Polymer({
    is: "saint-laurent",

    properties:{},
    ready: function () {
      this.stations = [
        {stop: "1372", route: "0009", direction:"0" , label: "9",  color: "blue"},
        {stop: "1485", route: "0071", direction:"0" , label: "71", color: ""},
        {stop: "1103", route: "0003", direction:"0" , label: "3",  color: "darkgreen"},
        {stop: "1485", route: "0051", direction:"0" , label: "51", color: ""}
      ];
      console.log('watch');

      this._getAndSort();
    },

    _getAndSort() {
      var fetches = [];
      for (let i of this.stations) {

        let param = [
          ["stop", i.stop],
          ["route", i.route],
          ["direction", i.direction]
        ]
        .map(i => i.join("="))
        .join("&");

        fetches.push(fetch("/api/2.0?" + param)
          .then(i => i.json())
        );
      }

      Promise.all(fetches).then(values => {
        return values.filter(i => i !== null)
        .map(i => i.departures.map(j => {
            return {
              "stop": i.stop,
              "route": i.route,
              "direction": i.direction,
              "time": j
            };
          }))
      }).then(i => console.log(i));
    }

  });
</script>
